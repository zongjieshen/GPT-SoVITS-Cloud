# Minimal Dockerfile for GPT-SoVITS API v2 Service
FROM python:3.11-slim

LABEL maintainer="GPT-SoVITS API v2"
LABEL version="1.0"
LABEL description="Minimal Docker image for GPT-SoVITS API v2 service"

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    gcc \
    g++ \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements-api-v2.txt /app/
RUN pip install --no-cache-dir -r requirements-api-v2.txt

# Copy only the necessary files for API v2
COPY api_v2.py /app/
COPY config.py /app/

# Copy the entire GPT_SoVITS folder
COPY GPT_SoVITS/ /app/GPT_SoVITS/

# Copy the entire tools folder
COPY tools/ /app/tools/

# Create pretrained_models directory (will be mounted)
RUN mkdir -p /app/GPT_SoVITS/pretrained_models

# Set environment variables
ENV PYTHONPATH="/app"
ENV PYTHONUNBUFFERED=1

# Expose the API port
EXPOSE 9880

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:9880/docs || exit 1

# Command to run the API
CMD ["python", "api_v2.py", "-a", "0.0.0.0", "-p", "9880", "-c", "GPT_SoVITS/configs/tts_infer.yaml"]